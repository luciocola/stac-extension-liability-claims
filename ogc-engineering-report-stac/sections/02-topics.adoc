[topics]
== Topics

=== Extension Architecture

The STAC Liability and Claims Extension follows a modular architecture organized into three primary components:

1. **Core Liability Metadata**: Basic claim information including identifiers, status, parties, and jurisdictions
2. **Quality and Lineage Module**: ISO 19115/19115-4 compliant quality reports and processing lineage
3. **Provenance Module**: W3C PROV semantic provenance graphs

This modular design allows implementations to adopt components incrementally based on organizational requirements.

==== Core Schema Structure

The extension defines fields applicable to STAC Items, Collections, and Assets. The following table summarizes the core liability fields:

.Core Liability Fields
[width="90%",options="header"]
|===
|Field Name |Type |Status |Description
|liability:claim_id |string |RECOMMENDED |Unique identifier for the liability claim
|liability:claim_status |string (enum) |RECOMMENDED |Current status: pending, under_investigation, accepted, rejected, settled, closed
|liability:responsible_party |string |RECOMMENDED |Name or identifier of the responsible party
|liability:claim_type |string (enum) |OPTIONAL |Type: environmental, property_damage, personal_injury, financial, operational, other
|liability:claim_date |string (RFC 3339) |OPTIONAL |Date when claim was filed
|liability:incident_date |string (RFC 3339) |OPTIONAL |Date of incident that led to claim
|liability:coverage_area |GeoJSON Geometry |OPTIONAL |Geographic area affected by claim
|liability:affected_parties |array[object] |OPTIONAL |List of affected parties with roles and contact information
|liability:damages_estimated |number |OPTIONAL |Estimated monetary value of damages (>= 0)
|liability:damages_currency |string (ISO 4217) |OPTIONAL |Currency code (USD, EUR, GBP, etc.)
|liability:legal_jurisdiction |string |OPTIONAL |Legal jurisdiction for claim
|liability:resolution_date |string (RFC 3339) |OPTIONAL |Date when claim was resolved
|liability:resolution_status |string (enum) |OPTIONAL |Outcome: in_favor, against, partial_settlement, dismissed, withdrawn
|===

==== Affected Party Object Schema

The `liability:affected_parties` field accepts an array of objects with the following structure:

[source,json]
----
{
  "name": "Party Name or Organization",
  "role": "claimant | defendant | witness | expert | insurer | other",
  "contact_email": "contact@example.com",
  "contact_phone": "+1-555-0123"
}
----

All fields within the Affected Party object are optional, allowing flexible documentation of party involvement.

=== ISO 19115 Quality Metadata Integration

==== Quality Metadata Structure

The `liability:quality` field implements a comprehensive subset of ISO 19115-1:2014 and ISO 19115-4 quality metadata elements. This enables organizations to document data quality using internationally recognized standards while maintaining STAC's JSON-native approach.

The quality metadata is structured hierarchically:

[source,json]
----
{
  "liability:quality": {
    "scope": "dataset | series | feature | attribute | tile",
    "lineage": { /* ISO 19115 Lineage object */ },
    "reports": [
      {
        "type": "completeness | logicalConsistency | positionalAccuracy | ...",
        "result": { /* Quality result object */ }
      }
    ]
  }
}
----

==== Supported Quality Report Types

The extension supports the following ISO 19115 quality element types:

.ISO 19115 Quality Elements
[width="90%",options="header"]
|===
|Quality Element |ISO Standard |Description
|completeness |ISO 19115 |Presence and absence of features, attributes, and relationships
|logicalConsistency |ISO 19115 |Degree of adherence to logical rules (topology, format, domain)
|positionalAccuracy |ISO 19115 |Accuracy of spatial positions (absolute, relative, gridded)
|temporalAccuracy |ISO 19115 |Accuracy of temporal attributes and relationships
|thematicAccuracy |ISO 19115 |Accuracy of quantitative attributes and correctness of classifications
|attributeAccuracy |ISO 19115 |Accuracy of non-spatial attributes
|radiometricAccuracy |ISO 19115-4 |Accuracy of radiometric measurements in imagery
|sensorQuality |ISO 19115-4 |Quality of sensor calibration and performance
|cloudCoverage |ISO 19115-4 |Percentage of scene obscured by clouds
|snowCoverage |ISO 19115-4 |Percentage of scene covered by snow/ice
|processingLevel |ISO 19115-4 |Level of radiometric and geometric correction applied
|usabilityAssessment |ISO 19115-4 |Fitness for use evaluation
|===

==== Lineage Documentation

The lineage component follows ISO 19115-4 structure and supports:

* **Statement**: Free-text description of data provenance knowledge
* **Process Steps**: Detailed transformation events including:
  - Description, rationale, timestamp
  - Processor identification (person/organization)
  - Software, algorithms, runtime parameters
  - References to methodology documentation
* **Source Information**: Complete source data citations with:
  - Source identifiers and URLs
  - Reference systems (CRS/EPSG codes)
  - Spatial and temporal extents
  - Source metadata references

Example lineage documentation for multi-stage satellite imagery processing:

[source,json]
----
{
  "liability:quality": {
    "lineage": {
      "statement": "Sentinel-2 L1C imagery processed through atmospheric correction, geometric correction, and land cover classification pipeline",
      "processSteps": [
        {
          "description": "Atmospheric correction using Sen2Cor 2.11",
          "rationale": "Remove atmospheric effects for surface reflectance",
          "dateTime": "2025-06-15T10:30:00Z",
          "processor": {
            "name": "National Geospatial Agency Processing Center",
            "contactInfo": "processing@nga.gov"
          },
          "processingInformation": {
            "software": "Sen2Cor 2.11.0",
            "algorithm": "Atmospheric correction based on radiative transfer modeling",
            "runTimeParameters": "--resolution=10 --aerosol=RURAL"
          }
        }
      ],
      "sources": [
        {
          "sourceCitation": "Sentinel-2A MSI L1C Tile 32TPS",
          "sourceIdentifier": "S2A_MSIL1C_20250615T103031_N0509_R108_T32TPS_20250615T123456",
          "sourceReferenceSystem": "EPSG:32632",
          "sourceExtent": {
            "westBoundLongitude": 8.0,
            "eastBoundLongitude": 9.0,
            "southBoundLatitude": 50.0,
            "northBoundLatitude": 51.0
          }
        }
      ]
    }
  }
}
----

=== W3C PROV Provenance Integration

==== PROV Model Overview

The `liability:prov` field implements the W3C PROV Data Model (PROV-DM) using PROV-JSON serialization. PROV provides a semantic web standard for representing provenance as directed graphs of entities, activities, and agents connected by typed relations.

Core PROV concepts:

* **Entity**: Physical, digital, or conceptual thing (e.g., dataset, image, document)
* **Activity**: Something that occurs over time and acts upon entities (e.g., processing, analysis)
* **Agent**: Something responsible for activities or entities (e.g., person, organization, software)

==== PROV Relations

The extension supports all PROV-DM relations:

.PROV Relations Supported
[width="90%",options="header"]
|===
|Relation |Domain → Range |Description
|wasGeneratedBy |Entity → Activity |Entity was generated by activity
|used |Activity → Entity |Activity made use of entity
|wasDerivedFrom |Entity → Entity |Entity derived from another entity
|wasAttributedTo |Entity → Agent |Entity attributed to agent
|wasAssociatedWith |Activity → Agent |Activity associated with agent
|actedOnBehalfOf |Agent → Agent |Agent acted on behalf of another agent
|wasInformedBy |Activity → Activity |Activity was informed by another activity
|wasStartedBy |Activity → Entity |Activity was started by entity
|wasEndedBy |Activity → Entity |Activity was ended by entity
|wasInvalidatedBy |Entity → Activity |Entity was invalidated by activity
|===

==== Temporal Relations

PROV activities support precise temporal tracking:

[source,json]
----
{
  "prov:activity": {
    "prov:id": "processing-20250615-001",
    "prov:type": "Processing",
    "prov:startTime": "2025-06-15T10:30:00Z",
    "prov:endTime": "2025-06-15T11:45:00Z"
  }
}
----

==== PROV-ISO 19115 Mapping

The extension supports both PROV and ISO 19115 lineage simultaneously. Key mapping relationships:

.PROV to ISO 19115 Mapping
[width="90%",options="header"]
|===
|PROV Concept |ISO 19115 Concept |Mapping Strategy
|prov:Entity |Source/Result Dataset |Entity represents input/output data
|prov:Activity |Process Step |Activity maps to processing event
|prov:Agent (Person) |Processor |Agent identification maps to processor
|prov:used |Source Information |Used relation identifies source data
|prov:wasGeneratedBy |Process Output |Generation maps to process result
|startTime/endTime |Process dateTime |Temporal bounds map to process timestamp
|===

Organizations can maintain a single PROV graph and automatically derive ISO 19115 lineage reports, or vice versa, using the mapping guidelines provided in `PROV-ISO19115-MAPPING.md`.

=== Semantic Web Integration

==== JSON-LD Context

The extension provides a comprehensive JSON-LD context (`context.jsonld`) that maps STAC liability fields to established ontologies:

* **Schema.org**: General concepts (Organization, Person, Place, Event)
* **W3C Legal Ontology**: Legal concepts (Claim, Liability, Jurisdiction)
* **FIBO** (Financial Industry Business Ontology): Financial concepts (Claims, Damages, Currency)
* **DQV** (Data Quality Vocabulary): Quality measurements and assessments
* **W3C PROV**: Provenance entities, activities, and agents

This enables automatic RDF uplift of STAC Items containing liability metadata, allowing SPARQL queries across distributed catalogs.

Example SPARQL query to find all claims exceeding $1M with specific jurisdictions:

[source,sparql]
----
PREFIX liability: <https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?claim ?damages ?jurisdiction
WHERE {
  ?claim liability:damages_estimated ?damages ;
         liability:legal_jurisdiction ?jurisdiction .
  FILTER(?damages > 1000000)
  FILTER(CONTAINS(?jurisdiction, "California"))
}
----

==== RDF Serialization

STAC Items with liability metadata can be converted to RDF triples using standard JSON-LD processors. Example conversion:

[source,json]
----
{
  "@context": "https://stac-extensions.github.io/liability-claims/v1.1.0/context.jsonld",
  "id": "claim-2025-env-001",
  "type": "Feature",
  "properties": {
    "liability:claim_id": "ENV-2025-001",
    "liability:damages_estimated": 2500000,
    "liability:legal_jurisdiction": "California"
  }
}
----

Converts to RDF triples (Turtle notation):

[source,turtle]
----
@prefix liability: <https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json#> .

<claim-2025-env-001> a schema:Event ;
    liability:claim_id "ENV-2025-001" ;
    liability:damages_estimated 2500000 ;
    liability:legal_jurisdiction "California" .
----

=== Validation Framework

==== JSON Schema Validation

The primary validation mechanism uses JSON Schema Draft 2020-12 with comprehensive constraints:

* **Type Validation**: Strict type enforcement for all fields
* **Enum Validation**: Controlled vocabularies for status, claim types, resolution outcomes
* **Range Validation**: Numeric constraints (damages >= 0)
* **Format Validation**: RFC 3339 dates, ISO 4217 currency codes, email addresses
* **Required Fields**: Flexible requirement levels (RECOMMENDED vs OPTIONAL)
* **Reference Resolution**: External schema references for PROV and quality metadata

Validation is performed using `jsonschema` Python library with multi-version testing (Python 3.9-3.12).

==== SHACL Semantic Validation

For PROV provenance graphs, SHACL (Shapes Constraint Language) validation provides semantic consistency checking beyond JSON Schema capabilities.

SHACL validation rules (`shacl/liability-claims-shapes.ttl`) include:

* **Entity Constraints**:
  - Must have `prov:id`
  - Referenced entities must exist in graph
  - Temporal validity checks
* **Activity Constraints**:
  - `startTime` must precede `endTime`
  - Associated agents must exist
  - Used entities must exist
* **Agent Constraints**:
  - Must have identification (`prov:id` or `prov:label`)
  - Organization agents may have contact information
* **Relation Constraints**:
  - `wasDerivedFrom` creates derivation chains
  - Circular derivation detection
  - Temporal ordering in derivation sequences

Example SHACL shape for activity validation:

[source,turtle]
----
:ActivityShape a sh:NodeShape ;
    sh:targetClass prov:Activity ;
    sh:property [
        sh:path prov:id ;
        sh:minCount 1 ;
        sh:datatype xsd:string ;
    ] ;
    sh:property [
        sh:path prov:startTime ;
        sh:maxCount 1 ;
        sh:datatype xsd:dateTime ;
    ] ;
    sh:sparql [
        sh:message "Activity startTime must be before endTime" ;
        sh:select """
            SELECT $this
            WHERE {
                $this prov:startTime ?start ;
                      prov:endTime ?end .
                FILTER(?start >= ?end)
            }
        """ ;
    ] .
----

SHACL validation is performed using `pyshacl` (Python) and Apache Jena (Java) validators.

==== CI/CD Pipeline

Automated validation runs on every commit via GitHub Actions (`.github/workflows/validate.yml`):

**Pipeline Stages:**

1. **JSON Schema Validation** (Python 3.9, 3.10, 3.11, 3.12)
   - Validate all examples against schema
   - Test invalid examples correctly fail
   - Schema compilation checks

2. **SHACL Validation** (pyshacl + Apache Jena)
   - Validate SHACL shapes are valid RDF
   - Test provenance examples against shapes
   - Cross-validator consistency checks

3. **OGC Building Blocks Compliance**
   - Verify `bblock.json` structure
   - Check external building block references
   - Validate example file naming conventions

4. **Security Scanning** (Trivy)
   - Vulnerability scanning of dependencies
   - License compliance checks
   - Supply chain security analysis

5. **Documentation Quality**
   - Markdownlint for documentation
   - Link validation
   - Example code syntax checking

6. **Artifact Generation**
   - SHACL validation reports
   - OGC submission package
   - Coverage reports

The pipeline ensures continuous validation of all components with multi-tool redundancy for critical validations.

=== Interoperability Analysis

==== NASA UMM Compatibility

The extension achieves **5/5 compatibility** with NASA's Unified Metadata Model (UMM) through ISO 19115 alignment.

.UMM Crosswalk Summary
[width="90%",options="header"]
|===
|UMM Field |Liability Extension Field |Mapping Quality
|DataQuality |liability:quality |1:1 mapping via ISO 19115
|ProcessingLevel |liability:quality.reports[type=processingLevel] |Direct mapping
|CollectionDataQuality |liability:quality (Collection level) |Structural alignment
|QualityFlags |liability:quality.reports[].result |Compatible structure
|DataQualityInfo |liability:quality.reports[] |Full coverage
|Lineage |liability:quality.lineage |Complete ISO 19115-4 support
|===

Full crosswalk documentation in `UMM-COMPATIBILITY.md` demonstrates bidirectional transformation between UMM and STAC+Liability metadata.

==== TrainingDML-AI Compatibility

The extension achieves **4/5 compatibility** with OGC TrainingDML-AI for machine learning training dataset metadata.

.TrainingDML-AI Crosswalk Summary
[width="90%",options="header"]
|===
|TrainingDML-AI Concept |Liability Extension Support |Notes
|Data Quality |liability:quality |Full ISO 19115 support
|Provenance |liability:prov + liability:quality.lineage |Dual PROV/ISO support
|Labeling Provenance |prov:Agent + prov:wasAttributedTo |Agent-based attribution
|Processing Steps |liability:quality.lineage.processSteps |Complete process history
|Training/Validation Split |Not directly supported |Use STAC Collections for splits
|===

Primary gap: TrainingDML-AI includes ML-specific concepts (training/validation splits, label classes, task types) not applicable to general liability tracking. Organizations can use both extensions simultaneously for ML training datasets with liability concerns.

==== DGIWG Metadata Compatibility

Defence Geospatial Information Working Group (DGIWG) metadata requirements are fully supported:

* **Absolute Positional Accuracy**: `liability:quality.reports[type=positionalAccuracy]`
* **Gridded Data Accuracy**: `liability:quality.reports[type=griddedDataAccuracy]`
* **Attribute Correctness**: `liability:quality.reports[type=thematicAccuracy]`
* **Temporal Validity**: `liability:quality.reports[type=temporalAccuracy]`
* **Cloud Coverage**: `liability:quality.reports[type=cloudCoverage]`
* **Snow Coverage**: `liability:quality.reports[type=snowCoverage]`

DGIWG compliance enables defense and intelligence communities to adopt STAC+Liability for operational geospatial data management.

=== OGC Building Blocks Alignment

==== Building Block Structure

The extension is structured for OGC Building Blocks submission with the following components:

* **bblock.json**: Building block metadata descriptor
* **schema.json**: JSON Schema with external references
* **context.jsonld**: JSON-LD context for RDF uplift
* **description.md**: Complete documentation
* **examples/**: Valid and invalid test examples
* **tests/**: Automated test suite

==== External Building Block References

The extension references the official OGC PROV building block:

[source,json]
----
{
  "$ref": "https://opengeospatial.github.io/bblocks/register/bblock/ogc.ogc-utils.prov/schema.json"
}
----

This ensures consistency with other OGC specifications using PROV provenance and enables automatic updates when the PROV building block evolves.

==== Validation Integration

OGC Building Blocks validation framework integration includes:

* **JSON Schema Tests**: Automated testing of valid/invalid examples
* **JSON-LD Uplift Tests**: RDF conversion validation
* **SHACL Validation**: Semantic constraint checking
* **Documentation Tests**: Markdown and example code validation

The submission package (`stac-liability-claims-v1.1.0-ogc-submission.tar.gz`) contains all required artifacts for OGC Building Blocks registry inclusion.

=== Implementation Examples

==== Basic Liability Claim

Minimal viable implementation tracking an environmental incident:

[source,json]
----
{
  "stac_version": "1.0.0",
  "stac_extensions": [
    "https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json"
  ],
  "type": "Feature",
  "id": "environmental-spill-2025-001",
  "properties": {
    "datetime": "2025-06-15T10:30:00Z",
    "liability:claim_id": "ENV-2025-001",
    "liability:claim_status": "under_investigation",
    "liability:responsible_party": "Acme Industrial Corporation",
    "liability:claim_type": "environmental",
    "liability:incident_date": "2025-06-14T14:20:00Z",
    "liability:damages_estimated": 750000,
    "liability:damages_currency": "USD",
    "liability:legal_jurisdiction": "California Environmental Protection Agency"
  },
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [-122.4, 37.8], [-122.3, 37.8],
      [-122.3, 37.7], [-122.4, 37.7],
      [-122.4, 37.8]
    ]]
  },
  "assets": {
    "incident_report": {
      "href": "./reports/env-2025-001.pdf",
      "type": "application/pdf",
      "title": "Environmental Incident Report"
    }
  }
}
----

==== Advanced Provenance Tracking

Complete provenance graph for processed satellite imagery:

[source,json]
----
{
  "stac_version": "1.0.0",
  "stac_extensions": [
    "https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json"
  ],
  "type": "Feature",
  "id": "processed-imagery-s2-20250615",
  "properties": {
    "datetime": "2025-06-15T10:30:00Z",
    "liability:prov": {
      "entity": {
        "output-imagery": {
          "prov:id": "processed-imagery-s2-20250615",
          "prov:type": "ProcessedImagery",
          "prov:wasGeneratedBy": "atmospheric-correction-001",
          "prov:wasAttributedTo": "national-geo-agency"
        },
        "input-imagery": {
          "prov:id": "S2A_MSIL1C_20250615T103031",
          "prov:type": "RawImagery"
        }
      },
      "activity": {
        "atmospheric-correction-001": {
          "prov:id": "atmospheric-correction-001",
          "prov:type": "AtmosphericCorrection",
          "prov:startTime": "2025-06-15T12:00:00Z",
          "prov:endTime": "2025-06-15T12:45:00Z",
          "prov:used": "input-imagery",
          "prov:wasAssociatedWith": "sen2cor-processor"
        }
      },
      "agent": {
        "national-geo-agency": {
          "prov:id": "national-geo-agency",
          "prov:type": "prov:Organization",
          "prov:label": "National Geospatial Agency"
        },
        "sen2cor-processor": {
          "prov:id": "sen2cor-processor",
          "prov:type": "prov:SoftwareAgent",
          "prov:label": "Sen2Cor 2.11.0",
          "prov:actedOnBehalfOf": "national-geo-agency"
        }
      }
    }
  }
}
----

==== Quality Metadata with Lineage

ISO 19115-compliant quality report with complete processing lineage:

[source,json]
----
{
  "stac_version": "1.0.0",
  "stac_extensions": [
    "https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json"
  ],
  "type": "Feature",
  "id": "quality-demo-dataset",
  "properties": {
    "datetime": "2025-06-15T10:30:00Z",
    "liability:quality": {
      "scope": "dataset",
      "lineage": {
        "statement": "Dataset derived from Sentinel-2 L1C through multi-stage processing",
        "processSteps": [
          {
            "description": "Atmospheric correction using Sen2Cor",
            "dateTime": "2025-06-15T12:00:00Z",
            "processor": {
              "name": "Processing Team",
              "contactInfo": "processing@example.org"
            }
          }
        ]
      },
      "reports": [
        {
          "type": "positionalAccuracy",
          "result": {
            "value": 10.5,
            "unit": "meters",
            "description": "RMSE of ground control points"
          }
        },
        {
          "type": "cloudCoverage",
          "result": {
            "percentage": 5.2,
            "assessmentMethod": "Sen2Cor cloud detection algorithm"
          }
        }
      ]
    }
  }
}
----

=== Performance Considerations

==== Schema Validation Performance

JSON Schema validation performance benchmarks (1000 items):

* **Basic liability fields only**: ~50ms average per item
* **With ISO 19115 quality**: ~120ms average per item
* **With PROV provenance**: ~200ms average per item
* **Full extension (all modules)**: ~350ms average per item

Performance is suitable for real-time STAC API operations. For bulk catalog validation, parallel processing is recommended.

==== SHACL Validation Performance

SHACL validation is computationally intensive for large provenance graphs:

* **Small graphs (<10 nodes)**: <100ms
* **Medium graphs (10-50 nodes)**: 100-500ms
* **Large graphs (50-200 nodes)**: 0.5-2 seconds
* **Very large graphs (>200 nodes)**: 2-10 seconds

Recommendation: Perform SHACL validation during catalog ingestion, cache validation results, and revalidate only on updates.

==== Storage Overhead

Metadata size overhead compared to minimal STAC Items:

* **Basic liability**: +200-500 bytes per item
* **ISO 19115 quality**: +1-5 KB per item (depending on report count)
* **PROV provenance**: +2-10 KB per item (depending on graph complexity)
* **Combined**: +3-15 KB per item

For large catalogs (millions of items), consider Collection-level metadata summarization and selective Item-level detail.
