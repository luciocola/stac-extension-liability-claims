name: Validate Extension

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install jsonschema
        pip install pystac
        pip install requests
    
    - name: Validate JSON Schema
      run: |
        python -c "
        import json
        from jsonschema import Draft7Validator
        
        with open('v1.1.0/schema.json') as f:
            schema = json.load(f)
        
        validator = Draft7Validator(schema)
        errors = list(validator.iter_errors(schema))
        
        if errors:
            for error in errors:
                print(f'Schema error: {error.message}')
            exit(1)
        else:
            print('✓ Schema is valid')
        "
    
    - name: Validate Examples
      run: |
        for file in v1.1.0/examples/*.json; do
          echo "Validating $file..."
          python -c "
        import json
        import sys
        
        with open('$file') as f:
            item = json.load(f)
        
        # Basic STAC validation
        if 'stac_extensions' not in item:
            print('Missing stac_extensions')
            sys.exit(1)
            
        ext_url = 'https://stac-extensions.github.io/liability-claims/v1.1.0/schema.json'
        if ext_url not in item.get('stac_extensions', []):
            print(f'Extension {ext_url} not declared')
            sys.exit(1)
        
        print('✓ Valid STAC Item/Collection')
          "
        done
    
    - name: Check README
      run: |
        if [ ! -f "v1.1.0/README.md" ]; then
          echo "❌ Missing README.md"
          exit 1
        fi
        echo "✓ README.md exists"
    
    - name: Check CHANGELOG
      run: |
        if [ ! -f "v1.1.0/CHANGELOG.md" ]; then
          echo "❌ Missing CHANGELOG.md"
          exit 1
        fi
        echo "✓ CHANGELOG.md exists"
